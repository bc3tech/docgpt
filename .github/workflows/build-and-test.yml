name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  EXTENSION_VERSION: 1.0.${{ github.run_number }}

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.x"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          show-progress: false

      - name: Run unit tests
        run: dotnet test ./DocGpt.Test/DocGpt.Test.csproj --configuration Release

  package-extension:
    # VS extension packaging requires netfx, so have to run it on Windows
    runs-on: windows-latest

    steps:
      - name: Setup MSBuild for NetFX
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: 17.0

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          show-progress: false

      - name: Bump version
        run: |
          # Use PowerShell to update the version in the VSIX manifest
          $xml = [xml](Get-Content -Path .\DocGpt.Vsix\source.extension.vsixmanifest)
          $identityNode = $xml.PackageManifest.Metadata.Identity
          $identityNode.SetAttribute('Version', $env:EXTENSION_VERSION)
          $xml.Save(".\DocGpt.Vsix\source.extension.vsixmanifest")

      - name: Restore NuGet packages
        run: nuget restore .\DocGpt.sln

      - name: Build Extension
        run: msbuild .\DocGpt.sln -p:Configuration=Release

      - name: Sign Extension
        run: lib\win\openvsixsigntool.exe sign -t "http://timestamp.digicert.com" ".\DocGpt.Vsix\bin\Release\DocGPT.vsix" -kvu "https://${{ secrets.AZURE_KEYVAULT_NAME }}.vault.azure.net" -kvt "${{ secrets.AZURE_TENANT_ID }}" -kvi "${{ secrets.AZURE_CLIENT_ID }}" -kvs "${{ secrets.AZURE_CLIENT_SECRET }}" -kvc "${{ secrets.SIGNING_CERTIFICATE_NAME }}"

      - name: Publish Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DocGpt.vsix
          path: DocGpt.Vsix\bin\Release\DocGPT.vsix

  publish-to-marketplace:
    needs: [run-tests, package-extension]
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: DocGPT.vsix
          path: ./DocGPT.vsix
      - name: Publish to marketplace
        uses: cezarypiatek/VsixPublisherAction@1.1
        with:
          extension-file: ./DocGPT.vsix
          publish-manifest-file: ./DocGpt.Vsix/publishmanifest.json
          personal-access-code: ${{ secrets.MARKETPLACE_PAT }}

  publish-release:
    needs: [run-tests, package-extension]
    runs-on: ubuntu-latest

    steps:
      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        run: |
          gh release create "${{ github.sha }}" \
            --repo="${{ github.repository }}" \
            --title="v${{ env.EXTENSION_VERSION }}" \
            --generate-notes